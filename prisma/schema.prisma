// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ── Auth models (NextAuth Prisma Adapter) ──

enum UserRole {
  ADMINISTRADOR
  FINANCEIRO
  OPERACIONAL
  VISUALIZADOR
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String    @unique
  emailVerified   DateTime?
  image           String?
  password        String?
  role            UserRole  @default(VISUALIZADOR)
  franqueadoraId  String?
  franqueadora    Franqueadora? @relation(fields: [franqueadoraId], references: [id])
  accounts        Account[]
  sessions        Session[]
  interactionsCreated InteractionLog[]
  tasksAssigned       CollectionTask[] @relation("TaskAssignee")
  tasksCreated        CollectionTask[] @relation("TaskCreator")
  conversationsAssigned Conversation[] @relation("ConversationAssignee")
  messagesSent        Message[]
  conversationReads   ConversationRead[]
  onboardingCompletedAt DateTime?
  checklistDismissedAt  DateTime?

  @@index([franqueadoraId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ── Business models ──

model Customer {
  id              String    @id @default(cuid())
  name            String
  doc             String
  email           String
  phone           String
  whatsappPhone   String?
  razaoSocial     String?
  cidade          String?
  estado          String?
  bairro          String?
  responsavel     String?
  statusLoja      String?   @default("Aberta")
  dataAbertura    DateTime?
  franqueadoraId  String?
  franqueadora    Franqueadora? @relation(fields: [franqueadoraId], references: [id])
  createdAt       DateTime  @default(now())
  charges         Charge[]
  interactions    InteractionLog[]
  collectionTasks CollectionTask[]
  conversations   Conversation[]
  agentDecisions  AgentDecisionLog[]
  messageQueue    MessageQueue[]
  omieCodigoCliente    BigInt?    @unique @map("omie_codigo_cliente")
  omieCodigoIntegracao String?    @map("omie_codigo_integracao")
  omieLastSyncAt       DateTime?  @map("omie_last_sync_at")

  @@index([franqueadoraId])
}

model Charge {
  id               String            @id @default(cuid())
  customerId       String
  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  description      String
  amountCents      Int
  dueDate          DateTime
  status           ChargeStatus      @default(PENDING)
  categoria        String?
  formaPagamento   String?
  nfEmitida        Boolean           @default(false)
  competencia      String?
  paidAt           DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  boleto           Boleto?
  notificationLogs NotificationLog[]
  interactions     InteractionLog[]
  collectionTasks  CollectionTask[]
  agentDecisions       AgentDecisionLog[]
  messageQueue         MessageQueue[]
  omieCodigoTitulo     BigInt?    @unique @map("omie_codigo_titulo")
  omieCodigoIntegracao String?    @map("omie_codigo_integracao")
  omieStatusRaw        String?    @map("omie_status_raw")
  omieLastSyncAt       DateTime?  @map("omie_last_sync_at")
  amountPaidCents      Int        @default(0) @map("amount_paid_cents")

  @@index([customerId])
  @@index([status])
  @@index([dueDate])
}

enum ChargeStatus {
  PENDING
  PAID
  OVERDUE
  CANCELED
  PARTIAL
}

model Boleto {
  id             String   @id @default(cuid())
  chargeId       String   @unique
  charge         Charge   @relation(fields: [chargeId], references: [id], onDelete: Cascade)
  linhaDigitavel String
  barcodeValue   String
  publicUrl      String
  createdAt      DateTime @default(now())
}

model DunningRule {
  id              String        @id @default(cuid())
  name            String
  active          Boolean       @default(true)
  timezone        String        @default("America/Sao_Paulo")
  franqueadoraId  String?
  franqueadora    Franqueadora? @relation(fields: [franqueadoraId], references: [id])
  createdAt       DateTime      @default(now())
  steps           DunningStep[]

  @@index([franqueadoraId])
}

model DunningStep {
  id               String            @id @default(cuid())
  ruleId           String
  rule             DunningRule       @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  trigger          DunningTrigger
  offsetDays       Int               @default(0)
  channel          Channel
  template         String
  enabled          Boolean           @default(true)
  createdAt        DateTime          @default(now())
  notificationLogs NotificationLog[]

  @@index([ruleId])
  @@index([trigger])
  @@index([enabled])
}

enum DunningTrigger {
  BEFORE_DUE
  ON_DUE
  AFTER_DUE
}

enum Channel {
  EMAIL
  SMS
  WHATSAPP
}

model NotificationLog {
  id              String             @id @default(cuid())
  chargeId        String
  charge          Charge             @relation(fields: [chargeId], references: [id], onDelete: Cascade)
  stepId          String
  step            DunningStep        @relation(fields: [stepId], references: [id], onDelete: Cascade)
  channel         Channel
  status          NotificationStatus
  scheduledFor    DateTime
  sentAt          DateTime?
  renderedMessage String
  metaJson        String
  createdAt       DateTime           @default(now())

  @@index([chargeId])
  @@index([stepId])
  @@index([scheduledFor])
}

enum NotificationStatus {
  SENT
  FAILED
  SKIPPED
}

model AppState {
  id           Int       @id @default(1)
  simulatedNow DateTime?
}

model Franqueadora {
  id                 String        @id @default(cuid())
  nome               String
  razaoSocial        String
  cnpj               String?
  email              String        @unique
  emailSecundario    String?
  endereco           String?
  celular            String?
  celularSecundario  String?
  telefone           String?
  telefoneSecundario String?
  responsavel        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  users              User[]
  customers          Customer[]
  dunningRules       DunningRule[]
  conversations      Conversation[]
  agentConfig        AgentConfig?
  contatos           ContatoFranqueadora[]
}

model ContatoFranqueadora {
  id              String       @id @default(cuid())
  franqueadoraId  String
  franqueadora    Franqueadora @relation(fields: [franqueadoraId], references: [id], onDelete: Cascade)
  nome            String
  telefone        String
  isPrimario      Boolean      @default(false)
  createdAt       DateTime     @default(now())

  @@index([franqueadoraId])
}

// ── Inbox / Agent enums ──

enum ConversationStatus {
  ABERTA
  PENDENTE_IA
  PENDENTE_HUMANO
  RESOLVIDA
}

enum MessageSender {
  CUSTOMER
  AGENT
  AI
  SYSTEM
}

enum MessageQueueStatus {
  PENDING
  PROCESSING
  SENT
  DELIVERED
  FAILED
  DEAD_LETTER
}

enum AgentAction {
  SEND_COLLECTION
  RESPOND_CUSTOMER
  ESCALATE_HUMAN
  NEGOTIATE
  SKIP
  MARK_PROMISE
  UPDATE_STATUS
}

enum EscalationReason {
  LEGAL_THREAT
  COMPLAINT_AUTHORITY
  REPEATED_FAILURE
  HIGH_VALUE
  EXPLICIT_REQUEST
  EMOTIONAL_DISTRESS
  DISPUTE
  AI_UNCERTAINTY
}

// ── CRM Core models ──

enum InteractionType {
  EMAIL
  WHATSAPP
  SMS
  TELEFONE
  NOTA_INTERNA
}

enum InteractionDirection {
  INBOUND
  OUTBOUND
}

enum TaskStatus {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDA
  CANCELADA
}

enum TaskPriority {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

model InteractionLog {
  id          String               @id @default(cuid())
  customerId  String
  customer    Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  chargeId    String?
  charge      Charge?              @relation(fields: [chargeId], references: [id], onDelete: SetNull)
  type        InteractionType
  direction   InteractionDirection
  content     String               @db.Text
  createdById String
  createdBy   User                 @relation(fields: [createdById], references: [id])
  createdAt   DateTime             @default(now())

  @@index([customerId])
  @@index([chargeId])
  @@index([createdAt])
}

model CollectionTask {
  id           String       @id @default(cuid())
  customerId   String
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  chargeId     String?
  charge       Charge?      @relation(fields: [chargeId], references: [id], onDelete: SetNull)
  title        String
  description  String?      @db.Text
  status       TaskStatus   @default(PENDENTE)
  priority     TaskPriority @default(MEDIA)
  dueDate      DateTime?
  assignedToId String?
  assignedTo   User?        @relation("TaskAssignee", fields: [assignedToId], references: [id])
  completedAt  DateTime?
  createdById  String
  createdBy    User         @relation("TaskCreator", fields: [createdById], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([customerId])
  @@index([chargeId])
  @@index([assignedToId])
  @@index([status])
  @@index([dueDate])
}

// ── Inbox / Agent models ──

model Conversation {
  id              String             @id @default(cuid())
  customerId      String
  customer        Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  franqueadoraId  String
  franqueadora    Franqueadora       @relation(fields: [franqueadoraId], references: [id])
  channel         Channel
  status          ConversationStatus @default(ABERTA)
  subject         String?
  assignedToId    String?
  assignedTo      User?              @relation("ConversationAssignee", fields: [assignedToId], references: [id])
  lastMessageAt   DateTime           @default(now())
  resolvedAt      DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  messages        Message[]
  readReceipts    ConversationRead[]
  agentDecisions  AgentDecisionLog[]
  messageQueue    MessageQueue[]

  @@index([franqueadoraId, status, lastMessageAt])
  @@index([customerId])
  @@index([assignedToId])
}

model Message {
  id               String        @id @default(cuid())
  conversationId   String
  conversation     Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender           MessageSender
  senderUserId     String?
  senderUser       User?         @relation(fields: [senderUserId], references: [id])
  content          String        @db.Text
  contentType      String        @default("text")
  channel          Channel
  externalId       String?
  metadata         String?       @db.Text
  isInternal       Boolean       @default(false)
  interactionLogId String?
  createdAt        DateTime      @default(now())

  @@index([conversationId, createdAt])
  @@index([externalId])
}

model ConversationRead {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadAt     DateTime     @default(now())

  @@unique([conversationId, userId])
}

model AgentDecisionLog {
  id               String            @id @default(cuid())
  conversationId   String?
  conversation     Conversation?     @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  chargeId         String?
  charge           Charge?           @relation(fields: [chargeId], references: [id], onDelete: SetNull)
  customerId       String
  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  franqueadoraId   String
  action           AgentAction
  reasoning        String            @db.Text
  confidence       Float
  inputContext     String            @db.Text
  outputMessage    String?           @db.Text
  escalationReason EscalationReason?
  executedAt       DateTime?
  createdAt        DateTime          @default(now())

  @@index([franqueadoraId, createdAt])
  @@index([customerId])
  @@index([action])
}

model MessageQueue {
  id              String             @id @default(cuid())
  chargeId        String?
  charge          Charge?            @relation(fields: [chargeId], references: [id], onDelete: SetNull)
  customerId      String
  customer        Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  conversationId  String?
  conversation    Conversation?      @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  channel         Channel
  content         String             @db.Text
  status          MessageQueueStatus @default(PENDING)
  priority        Int                @default(0)
  scheduledFor    DateTime
  attemptCount    Int                @default(0)
  maxAttempts     Int                @default(3)
  lastAttemptAt   DateTime?
  lastError       String?            @db.Text
  providerMsgId   String?
  franqueadoraId  String
  sentAt          DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([status, scheduledFor])
  @@index([franqueadoraId])
  @@index([customerId])
}

model AgentConfig {
  id                   String       @id @default(cuid())
  franqueadoraId       String       @unique
  franqueadora         Franqueadora @relation(fields: [franqueadoraId], references: [id])
  enabled              Boolean      @default(true)
  maxDailyMessages     Int          @default(100)
  escalationThreshold  Float        @default(0.3)
  highValueThreshold   Int          @default(1000000)
  workingHoursStart    Int          @default(8)
  workingHoursEnd      Int          @default(20)
  timezone             String       @default("America/Sao_Paulo")
  systemPromptOverride String?      @db.Text
  whatsappFrom         String?      @unique
  smsFrom              String?      @unique
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
}
